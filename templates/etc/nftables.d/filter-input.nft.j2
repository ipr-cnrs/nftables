#jinja2: lstrip_blocks: "True", trim_blocks: "True"
# {{ ansible_managed }}
{% from './templates/etc/nftables.d/defines.j2' import definemerged with context %}
{% set inputmerged = nft_input_default_rules.copy() %}
{% set _ = inputmerged.update(nft_input_rules) %}
{% set _ = inputmerged.update(nft_input_group_rules) %}
{% if nft_merged_groups and hostvars[inventory_hostname]['nft_combined_rules'].nft_input_group_rules is defined %}
  {% set _ = inputmerged.update(hostvars[inventory_hostname]['nft_combined_rules'].nft_input_group_rules) %}
{% endif %}
{% set _ = inputmerged.update(nft_input_host_rules) %}

chain input {
{% for group, rules in inputmerged|dictsort %}
  {% for def in definemerged if definemerged[def].value is defined %}
    {% if definemerged[def].value == 'none' %}
      {% set skipempty = true %}
    {% endif %}
    {% set searchstr = '\@' ~ definemerged[def].name %}
    {% if not rules | select('search', searchstr ) and skipempty is true %}
    # {{ group }}
      {% if not rules %}
    # (none)
      {% endif %}
      {% for rule in rules %}
    {{ rule }}
      {% endfor %}
    {% endif %}
  {% endfor %}
{% endfor %}
}
